generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  userType      String
  emailVerified Boolean   @default(false)
  verificationToken  String?   @unique
  resetToken         String?   @unique
  resetTokenExpiry   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  coachProfile    CoachProfile?
  ensembleProfiles EnsembleProfile[]
  sentMessages    Message[]  @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  favoriteCoaches FavoriteCoach[]
}

model CoachProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName          String
  city              String
  state             String
  country           String   @default("Australia")
  bio               String
  photoUrl          String?
  videoUrl          String?
  specialties       String
  ensembleTypes     String   @default("[]")
  experienceLevels  String
  contactMethod     String?
  contactDetail     String?
  rateHourly        Float?
  rateHalfDay       Float?
  rateFullDay       Float?
  ratesOnEnquiry    Boolean  @default(false)
  currency          String   @default("AUD")
  availability      String?
  rating            Float    @default(0)
  totalReviews      Int      @default(0)
  totalBookings     Int      @default(0)
  verified          Boolean  @default(false)
  approved          Boolean  @default(false)
  cancellationPolicy String?
  travelSupplement  Float?
  profileViews      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  bookings       Booking[]
  reviews        Review[]
  reviewInvites  ReviewInvite[]
  favoritedBy    FavoriteCoach[]
  coachSkills    CoachSkill[]

  @@index([approved, rating, totalBookings])
  @@index([state])
  @@index([city])
}

model EnsembleProfile {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ensembleName    String
  ensembleType    String
  size            Int
  city            String
  state           String
  country         String   @default("Australia")
  genres          String
  experienceLevel String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bookings       Booking[]
  reviews        Review[]
  reviewInvites  ReviewInvite[]

  @@unique([ensembleName, state, country])
  @@index([userId])
}

model Booking {
  id                String   @id @default(cuid())
  ensembleId        String
  ensemble          EnsembleProfile @relation(fields: [ensembleId], references: [id], onDelete: Cascade)
  coachId           String
  coach             CoachProfile @relation(fields: [coachId], references: [id], onDelete: Cascade)
  status            String   @default("pending")
  proposedDates     String
  confirmedDate     String?
  sessionType       String
  durationHours     Float?
  rate              Float
  travelCost        Float?
  totalCost         Float
  goals             String?
  specialRequests   String?
  cancellationReason String?
  cancelledBy       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  completedAt       DateTime?

  messages Message[]

  @@index([coachId, status])
  @@index([ensembleId, status])
}

model ReviewInvite {
  id              String   @id @default(cuid())
  coachProfileId  String
  coachProfile    CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  ensembleEmail   String
  ensembleName    String
  token           String   @unique @default(cuid())
  status          String   @default("pending")
  ensembleProfileId String?
  ensembleProfile   EnsembleProfile? @relation(fields: [ensembleProfileId], references: [id])
  review          Review?
  createdAt       DateTime @default(now())
  expiresAt       DateTime
}

model Review {
  id                     String   @id @default(cuid())
  inviteId               String   @unique
  invite                 ReviewInvite @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  reviewerId             String
  reviewer               EnsembleProfile @relation(fields: [reviewerId], references: [id], onDelete: Cascade)
  coachProfileId         String
  coachProfile           CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  rating                 Int
  reviewText             String?
  sessionMonth           Int
  sessionYear            Int
  sessionFormat          String
  validatedSkills        String   @default("[]")
  createdAt              DateTime @default(now())
}

model Message {
  id          String   @id @default(cuid())
  bookingId   String?
  booking     Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  recipientId String
  recipient   User     @relation("ReceivedMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  content     String
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@index([recipientId, read])
}

model FavoriteCoach {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  coachProfileId String
  coachProfile   CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@unique([userId, coachProfileId])
}

model Skill {
  id           String   @id @default(cuid())
  name         String
  category     String
  isCustom     Boolean  @default(false)
  showInFilter Boolean  @default(true)
  createdAt    DateTime @default(now())

  coachSkills  CoachSkill[]

  @@unique([name, category])
}

model CoachSkill {
  id               String       @id @default(cuid())
  coachProfileId   String
  coachProfile     CoachProfile @relation(fields: [coachProfileId], references: [id], onDelete: Cascade)
  skillId          String
  skill            Skill        @relation(fields: [skillId], references: [id], onDelete: Cascade)
  displayOrder     Int          @default(0)
  endorsementCount Int          @default(0)
  createdAt        DateTime     @default(now())

  @@unique([coachProfileId, skillId])
}

model AdminAuditLog {
  id          String   @id @default(cuid())
  adminId     String
  adminName   String
  action      String
  targetType  String
  targetId    String?
  targetName  String?
  details     String?
  createdAt   DateTime @default(now())
}

model Feedback {
  id        String   @id @default(cuid())
  userId    String
  userName  String
  userEmail String
  category  String
  message   String
  status    String   @default("new")
  adminNote String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([createdAt])
}
